{% extends "base.html" %} {% block title %}{{ report.title }}{% endblock %} {%
block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ report.title }}</h2>
    <div>
      <a
        href="{{ url_for('reports.download_report', id=report.id) }}"
        class="btn btn-primary"
      >
        <i class="fas fa-download"></i> Download
      </a>
      <a href="{{ url_for('reports.generate') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </a>
    </div>
  </div>

  <div class="card shadow mb-4">
    <div
      class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
    >
      <h6 class="m-0 font-weight-bold text-primary">Report Details</h6>
      <div class="dropdown no-arrow">
        <a
          class="dropdown-toggle"
          href="#"
          role="button"
          id="dropdownMenuLink"
          data-toggle="dropdown"
          aria-haspopup="true"
          aria-expanded="false"
        >
          <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
        </a>
        <div
          class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
          aria-labelledby="dropdownMenuLink"
        >
          <a
            class="dropdown-item"
            href="{{ url_for('reports.generate') }}?template={{ report.id }}"
          >
            <i class="fas fa-copy fa-sm fa-fw mr-2 text-gray-400"></i>
            Use as Template
          </a>
          <a class="dropdown-item" href="#" id="emailReportLink">
            <i class="fas fa-envelope fa-sm fa-fw mr-2 text-gray-400"></i>
            Email Report
          </a>
          <div class="dropdown-divider"></div>
          <a
            class="dropdown-item text-danger"
            href="#"
            id="deleteReportLink"
            data-id="{{ report.id }}"
          >
            <i class="fas fa-trash fa-sm fa-fw mr-2 text-gray-400"></i>
            Delete Report
          </a>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p>
            <strong>Generated:</strong> {{ report.timestamp.strftime('%Y-%m-%d
            %H:%M:%S') }}
          </p>
          <p>
            <strong>Report Type:</strong> {{ report.type|replace('_', ' ')|title
            }}
          </p>
          <p>
            <strong>Time Period:</strong> {{
            report.start_date.strftime('%Y-%m-%d') }} to {{
            report.end_date.strftime('%Y-%m-%d') }}
          </p>
        </div>
        <div class="col-md-6">
          <p>
            <strong>Format:</strong> {{ report.format|upper if report.format
            else 'HTML' }}
          </p>
          <p>
            <strong>Generated By:</strong> {{ report.user.username if
            report.user else 'System' }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Executive Summary Section -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Executive Summary</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-primary text-uppercase mb-1"
                  >
                    Total Packets
                  </div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">
                    {{ report_data.total_packets|default(0)|intcomma }}
                  </div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-network-wired fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-warning text-uppercase mb-1"
                  >
                    Total Alerts
                  </div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">
                    {{ report_data.total_alerts|default(0)|intcomma }}
                  </div>
                </div>
                <div class="col-auto">
                  <i
                    class="fas fa-exclamation-triangle fa-2x text-gray-300"
                  ></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-danger text-uppercase mb-1"
                  >
                    Critical Alerts
                  </div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">
                    {{ report_data.critical_alerts|default(0)|intcomma }}
                  </div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-radiation fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div
                    class="text-xs font-weight-bold text-success text-uppercase mb-1"
                  >
                    Detection Rate
                  </div>
                  <div class="h5 mb-0 font-weight-bold text-gray-800">
                    {{ report_data.detection_rate|default(0)|formatpercent }}
                  </div>
                </div>
                <div class="col-auto">
                  <i class="fas fa-shield-alt fa-2x text-gray-300"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <p>
          {{ report_data.summary|default('This report provides an overview of
          network security events and traffic analysis for the specified time
          period. The executive summary highlights key findings and metrics to
          provide situational awareness of your network security posture.') }}
        </p>

        {% if report_data.recommendations %}
        <div class="alert alert-info">
          <h5 class="alert-heading">Key Findings:</h5>
          <ul>
            {% for finding in report_data.findings|default([]) %}
            <li>{{ finding }}</li>
            {% else %}
            <li>No significant findings during this period.</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Traffic Analysis Section -->
  {% if 'traffic' in report_data.sections|default([]) %}
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Traffic Analysis</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- Traffic Volume Chart -->
        <div class="col-xl-8 col-lg-7">
          <div class="chart-area mb-4">
            <canvas id="trafficVolumeChart"></canvas>
          </div>
          <p class="text-center">Traffic volume over time</p>
        </div>

        <!-- Protocol Distribution Chart -->
        <div class="col-xl-4 col-lg-5">
          <div class="chart-pie mb-4">
            <canvas id="protocolChart"></canvas>
          </div>
          <p class="text-center">Protocol distribution</p>
        </div>
      </div>

      <div class="table-responsive mt-4">
        <h5>Top Traffic Sources</h5>
        <table class="table table-bordered" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th>Source IP</th>
              <th>Destination IP</th>
              <th>Protocol</th>
              <th>Packets</th>
              <th>Data Volume</th>
            </tr>
          </thead>
          <tbody>
            {% for flow in report_data.top_flows|default([]) %}
            <tr>
              <td>{{ flow.src_ip }}</td>
              <td>{{ flow.dst_ip }}</td>
              <td>{{ flow.protocol }}</td>
              <td>{{ flow.packets }}</td>
              <td>{{ flow.bytes|filesizeformat }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center">No traffic data available</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Alert Details Section -->
  {% if 'alerts' in report_data.sections|default([]) %}
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Alert Details</h6>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <!-- Alert Severity Chart -->
        <div class="col-xl-6 col-lg-6">
          <div class="chart-pie">
            <canvas id="alertSeverityChart"></canvas>
          </div>
          <p class="text-center">Alerts by severity</p>
        </div>

        <!-- Alert Categories Chart -->
        <div class="col-xl-6 col-lg-6">
          <div class="chart-bar">
            <canvas id="alertCategoryChart"></canvas>
          </div>
          <p class="text-center">Top attack categories</p>
        </div>
      </div>

      <div class="table-responsive mt-4">
        <h5>Notable Alerts</h5>
        <table class="table table-bordered" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Source IP</th>
              <th>Destination IP</th>
              <th>Severity</th>
              <th>Attack Category</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for alert in report_data.notable_alerts|default([]) %}
            <tr>
              <td>{{ alert.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
              <td>{{ alert.source_ip }}</td>
              <td>{{ alert.destination_ip }}</td>
              <td>
                <span
                  class="badge badge-{{ {
                                    'low': 'info',
                                    'medium': 'warning',
                                    'high': 'danger',
                                    'critical': 'dark'
                                }[alert.severity] }}"
                  >{{ alert.severity|upper }}</span
                >
              </td>
              <td>{{ alert.attack_category }}</td>
              <td>
                {% if alert.resolved %}
                <span class="badge badge-success">Resolved</span>
                {% else %}
                <span class="badge badge-warning">Pending</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center">
                No alerts to display for this period
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Recommendations Section -->
  {% if 'recommendations' in report_data.sections|default([]) %}
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        Security Recommendations
      </h6>
    </div>
    <div class="card-body">
      <div class="alert alert-warning">
        <h5 class="alert-heading">Security Recommendations:</h5>
        <ul>
          {% for recommendation in report_data.recommendations|default([]) %}
          <li>{{ recommendation }}</li>
          {% else %}
          <li>No specific recommendations at this time.</li>
          {% endfor %}
        </ul>
      </div>

      {% if report_data.remediation_steps %}
      <div class="mt-4">
        <h5>Remediation Steps</h5>
        <ol>
          {% for step in report_data.remediation_steps %}
          <li>{{ step }}</li>
          {% endfor %}
        </ol>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Email Report Modal -->
<div
  class="modal fade"
  id="emailReportModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="emailReportModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailReportModalLabel">Email Report</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="emailForm">
          <div class="form-group">
            <label for="email_recipients">Email Recipients</label>
            <input
              type="text"
              class="form-control"
              id="email_recipients"
              name="email_recipients"
              placeholder="Separate multiple emails with commas"
            />
          </div>
          <div class="form-group">
            <label for="email_subject">Subject</label>
            <input
              type="text"
              class="form-control"
              id="email_subject"
              name="email_subject"
              value="{{ report.title }}"
            />
          </div>
          <div class="form-group">
            <label for="email_message">Message (optional)</label>
            <textarea
              class="form-control"
              id="email_message"
              name="email_message"
              rows="3"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="sendEmailButton">
          Send Email
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Traffic Volume Chart
      {% if 'traffic' in report_data.sections|default([]) %}
      const trafficCtx = document.getElementById('trafficVolumeChart');
      new Chart(trafficCtx, {
          type: 'line',
          data: {
              labels: {{ report_data.traffic_labels|default([])|tojson }},
              datasets: [{
                  label: 'Traffic Volume',
                  data: {{ report_data.traffic_data|default([])|tojson }},
                  backgroundColor: 'rgba(78, 115, 223, 0.05)',
                  borderColor: 'rgba(78, 115, 223, 1)',
                  pointRadius: 3,
                  pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                  pointBorderColor: 'rgba(78, 115, 223, 1)',
                  pointHoverRadius: 3,
                  tension: 0.3
              }]
          },
          options: {
              plugins: {
                  legend: {
                      display: false
                  }
              },
              scales: {
                  x: {
                      grid: {
                          display: false
                      }
                  },
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });

      // Protocol Distribution Chart
      const protocolCtx = document.getElementById('protocolChart');
      new Chart(protocolCtx, {
          type: 'doughnut',
          data: {
              labels: {{ report_data.protocol_labels|default([])|tojson }},
              datasets: [{
                  data: {{ report_data.protocol_data|default([])|tojson }},
                  backgroundColor: [
                      '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                  ]
              }]
          },
          options: {
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              },
              cutout: '70%'
          }
      });
      {% endif %}

      {% if 'alerts' in report_data.sections|default([]) %}
      // Alert Severity Chart
      const severityCtx = document.getElementById('alertSeverityChart');
      new Chart(severityCtx, {
          type: 'doughnut',
          data: {
              labels: {{ report_data.severity_labels|default([])|tojson }},
              datasets: [{
                  data: {{ report_data.severity_data|default([])|tojson }},
                  backgroundColor: [
                      '#1cc88a', '#f6c23e', '#e74a3b', '#5a5c69'
                  ]
              }]
          },
          options: {
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              },
              cutout: '70%'
          }
      });

      // Alert Categories Chart
      const categoryCtx = document.getElementById('alertCategoryChart');
      new Chart(categoryCtx, {
          type: 'bar',
          data: {
              labels: {{ report_data.category_labels|default([])|tojson }},
              datasets: [{
                  label: 'Count',
                  data: {{ report_data.category_data|default([])|tojson }},
                  backgroundColor: 'rgba(78, 115, 223, 0.8)'
              }]
          },
          options: {
              plugins: {
                  legend: {
                      display: false
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
      {% endif %}

      // Delete report functionality
      document.getElementById('deleteReportLink').addEventListener('click', function(e) {
          e.preventDefault();
          const reportId = this.getAttribute('data-id');

          if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
              fetch(`/reports/delete/${reportId}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  }
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      window.location.href = "{{ url_for('reports.generate') }}";
                  } else {
                      alert('Error deleting report: ' + data.message);
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('An error occurred while deleting the report');
              });
          }
      });

      // Email report functionality
      document.getElementById('emailReportLink').addEventListener('click', function(e) {
          e.preventDefault();
          $('#emailReportModal').modal('show');
      });

      document.getElementById('sendEmailButton').addEventListener('click', function() {
          const recipients = document.getElementById('email_recipients').value;
          const subject = document.getElementById('email_subject').value;
          const message = document.getElementById('email_message').value;

          if (!recipients) {
              alert('Please enter at least one email recipient');
              return;
          }

          // Simple email validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          const emails = recipients.split(',').map(e => e.trim());

          for (let i = 0; i < emails.length; i++) {
              if (!emailRegex.test(emails[i])) {
                  alert(`Invalid email address: ${emails[i]}`);
                  return;
              }
          }

          // Disable button and show loading state
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

          fetch(`/reports/email/${reportId}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  recipients: recipients,
                  subject: subject,
                  message: message
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  $('#emailReportModal').modal('hide');
                  alert('Report sent successfully!');
              } else {
                  alert('Error sending report: ' + data.message);
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while sending the report');
          })
          .finally(() => {
              // Reset button state
              this.disabled = false;
              this.innerHTML = 'Send Email';
          });
      });
  });
</script>
{% endblock %}
